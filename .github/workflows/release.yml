# Release Workflow
# Manually triggered to create a tagged release with validation gates.
#
# Usage:
#   1. Go to Actions > Release > Run workflow
#   2. Enter version tag (e.g., v1.1.0)
#   3. Enter changelog description
#   4. Workflow validates, tags, and creates a GitHub release

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g. v1.1.0)"
        required: true
      changelog:
        description: "Changelog summary for this release"
        required: true

permissions:
  contents: write
  security-events: write

env:
  CHECKPOINT_DISABLE: 1
  TF_LOG: ERROR

jobs:
  #----------------------------------------------------------------------------
  # Gate 1: Terraform Format + Validation
  #----------------------------------------------------------------------------
  validate:
    name: Validate (${{ matrix.environment }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment:
          - commercial-classic
          - commercial-hcp
          - govcloud-classic
          - govcloud-hcp
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.6"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: environments/${{ matrix.environment }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: environments/${{ matrix.environment }}
        run: terraform validate

  #----------------------------------------------------------------------------
  # Gate 2: Security Scanning
  #----------------------------------------------------------------------------
  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy IaC scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "."
          severity: "HIGH,CRITICAL"
          skip-dirs: ".terraform"
          exit-code: "0"

  checkov:
    name: Checkov Policy Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          skip_check: CKV_AWS_144,CKV_AWS_145,CKV_AWS_124

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "."
          severity: warning
          format: gcc
        env:
          SHELLCHECK_OPTS: -x -e SC1091

  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #----------------------------------------------------------------------------
  # Release: Tag and publish (runs after all gates pass)
  #----------------------------------------------------------------------------
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, trivy, checkov, shellcheck, gitleaks]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag does not exist
        run: |
          if git rev-parse "${{ github.event.inputs.version }}" >/dev/null 2>&1; then
            echo "ERROR: Tag ${{ github.event.inputs.version }} already exists."
            exit 1
          fi

      - name: Generate changelog from commits
        id: auto_changelog
        run: |
          # Find the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "Previous tag: $PREV_TAG"
            COMMITS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "No previous tag found, using full history"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -50)
          fi
          
          # Write to file to preserve multiline content
          {
            echo "## What's Changed"
            echo ""
            echo "${{ github.event.inputs.changelog }}"
            echo ""
            echo "## Commits since ${PREV_TAG:-initial}"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "---"
            echo "*Full diff: [${PREV_TAG:-initial}...${{ github.event.inputs.version }}](https://github.com/${{ github.repository }}/compare/${PREV_TAG:-main}...${{ github.event.inputs.version }})*"
          } > release-notes.md
          
          cat release-notes.md

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ github.event.inputs.version }}" -m "Release ${{ github.event.inputs.version }}"
          git push origin "${{ github.event.inputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
