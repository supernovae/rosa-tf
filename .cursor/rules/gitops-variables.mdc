---
description: GitOps variable chain - shows all files to update when adding/modifying a GitOps layer variable
globs: environments/**/main.tf, environments/**/variables.tf, modules/gitops-layers/**/*.tf, gitops-layers/**/*.tftpl
alwaysApply: false
---

# GitOps Variable Chain

When adding a new variable to the GitOps layers (e.g., a new layer config, node placement option, or operator setting), you must update files across the full chain. Search for `GITOPS-VAR-CHAIN` to find every touchpoint.

## Variable Flow

```
User tfvars
  -> environments/*/variables.tf     (define the variable with type, description, default)
  -> environments/*/main.tf          (pass to module "gitops_resources" and/or module "gitops")
  -> modules/gitops-layers/operator/variables.tf   (accept in operator module)
  -> modules/gitops-layers/resources/variables.tf  (accept in resources module, if AWS infra)
  -> modules/gitops-layers/operator/main.tf        (use in templatefile() or null_resource)
  -> gitops-layers/layers/*/*.yaml.tftpl           (use in YAML template as ${var_name})
```

## Checklist: Adding a New GitOps Variable

1. **Module variable**: Add to `modules/gitops-layers/operator/variables.tf` (or `resources/variables.tf` if it creates AWS infrastructure)
2. **Shared variable** (optional): Add to `modules/gitops-layers/shared/layer-variables.tf` if shared across sub-modules
3. **Environment variables**: Add identical variable blocks to ALL 4 environments:
   - `environments/commercial-classic/variables.tf`
   - `environments/commercial-hcp/variables.tf`
   - `environments/govcloud-classic/variables.tf`
   - `environments/govcloud-hcp/variables.tf`
4. **Environment passthrough**: Add `var_name = var.var_name` to the appropriate module block in ALL 4 environments:
   - `environments/commercial-classic/main.tf`
   - `environments/commercial-hcp/main.tf`
   - `environments/govcloud-classic/main.tf`
   - `environments/govcloud-hcp/main.tf`
5. **Template** (if used in YAML): Add to the `templatefile()` call in `modules/gitops-layers/operator/main.tf` and use `${var_name}` in the `.yaml.tftpl` template
6. **Examples**: Update `examples/*.tfvars` if the variable is user-facing

## Key Discriminators

Only two values differ between environments:
- `cluster_type`: "classic" or "hcp" (controls PrometheusRules, set in `locals`)
- `is_govcloud`: derived from `data.aws_partition` (controls operator channels, set in `locals`)

All other GitOps variables are identical passthrough from `var.*` to module inputs.

## Module Structure

```
modules/gitops-layers/
  operator/     <- Installs operators + applies K8s manifests (main GitOps logic)
  resources/    <- Creates AWS infra (S3 buckets, IAM roles) for layers
  shared/       <- Shared variable definitions across sub-modules
  monitoring/   <- S3 + IAM for Loki (called by resources/)
  oadp/         <- S3 + IAM for OADP (called by resources/)
```
